name: "Update YAML with Kustomize"
description: "Custom action to patch a YAML file in another repo using kustomize"

inputs:
  target_repo:
    description: "Target repository"
    required: true
  repo_name:
    description: "Name of the repo"
    required: true
  branch:
    description: "Target branch"
    required: false
    default: "main"
  file_path:
    description: "Path to kustomization.yaml (relative to repo root)"
    required: true
  image_name:
    description: "Container image name"
    required: true
  image_tag:
    description: "Container image tag"
    required: true
  github_token:
    description: "GitHub token with write access to target repo"
    required: true

runs:
  using: "composite"
  steps:
    - name: Checkout target repo
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.target_repo }}
        ref: ${{ inputs.branch }}
        token: ${{ inputs.github_token }}
        path: ${{ inputs.repo_name }}
        ##state-files-repo

    - name: Debug repo contents
      shell: bash
      run: |
        echo "üìÇ Repo structure:"
        ls -R state-files-repo | head -50

    - name: Install Kustomize
      shell: bash
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/

    - name: Update kustomization.yaml
      shell: bash
      run: |
        echo "‚û°Ô∏è Updating file: ${{ inputs.file_path }}"
        echo "‚û°Ô∏è Setting image: ${{ inputs.image_name }}:${{ inputs.image_tag }}"

        cd "state-files-repo/$(dirname "${{ inputs.file_path }}")"
        kustomize edit set image "${{ inputs.image_name }}=${{ inputs.image_name }}:${{ inputs.image_tag }}"

        echo "‚úÖ kustomization.yaml updated successfully"

    - name: Commit & Push
      shell: bash
      run: |
        cd state-files-repo
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add "${{ inputs.file_path }}"
        git commit -m "Update image ${{ inputs.image_name }}:${{ inputs.image_tag }}" || echo "No changes to commit"
        git push origin ${{ inputs.branch }}

    - name: After
      shell: bash
      run: |
        echo "‚úÖ DONE"
